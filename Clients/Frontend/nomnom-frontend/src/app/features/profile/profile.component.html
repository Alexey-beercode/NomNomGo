<!-- src/app/features/profile/profile.component.html -->
<div class="profile-container" *ngIf="!loading">
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="profile-header">
    <button class="back-button" (click)="router.navigate(['/'])">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
  </div>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
  <div class="user-info-card" *ngIf="currentUser">
    <div class="user-avatar">
      <div class="avatar-circle">
        {{ getUserInitial() }}
      </div>
    </div>
    <div class="user-details">
      <h2>{{ currentUser.username }}</h2>
      <p>{{ currentUser.email }}</p>
      <div class="user-roles" *ngIf="currentUser.roles && currentUser.roles.length > 0">
        <span class="role-badge" *ngFor="let role of currentUser.roles">{{ role }}</span>
      </div>
    </div>
    <button class="logout-button" (click)="logout()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="16,17 21,12 16,7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="21" y1="12" x2="9" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
  <div class="tabs">
    <button
      class="tab-button"
      [class.active]="activeTab === 'profile'"
      (click)="setActiveTab('profile')">
      –ü—Ä–æ—Ñ–∏–ª—å
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab === 'orders'"
      (click)="setActiveTab('orders')">
      –ó–∞–∫–∞–∑—ã
    </button>
    <button
      class="tab-button"
      [class.active]="activeTab === 'settings'"
      (click)="setActiveTab('settings')">
      –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    </button>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
  <div class="tab-content">
    <!-- –í–∫–ª–∞–¥–∫–∞ –ü—Ä–æ—Ñ–∏–ª—å -->
    <div class="tab-panel" *ngIf="activeTab === 'profile'">
      <div class="profile-form-card">
        <div class="card-header">
          <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ñ–∏–ª–µ</h3>
          <button
            class="edit-button"
            *ngIf="!isEditingProfile"
            (click)="startEditingProfile()">
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
          </button>
        </div>

        <div class="profile-form" *ngIf="!isEditingProfile">
          <div class="form-field">
            <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <div class="field-value">{{ currentUser?.username || '‚Äî' }}</div>
          </div>
          <div class="form-field">
            <label>Email</label>
            <div class="field-value">{{ currentUser?.email || '‚Äî' }}</div>
          </div>
          <div class="form-field">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <div class="field-value">{{ currentUser?.phoneNumber || '‚Äî' }}</div>
          </div>
          <div class="form-field">
            <label>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
            <div class="field-value">{{ getFormattedCreatedDate() }}</div>
          </div>
        </div>

        <div class="profile-form" *ngIf="isEditingProfile">
          <div class="form-field">
            <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input
              type="text"
              [(ngModel)]="profileForm.username"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
          </div>
          <div class="form-field">
            <label>Email</label>
            <input
              type="email"
              [(ngModel)]="profileForm.email"
              placeholder="–í–≤–µ–¥–∏—Ç–µ email">
          </div>
          <div class="form-field">
            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
            <input
              type="tel"
              [(ngModel)]="profileForm.phoneNumber"
              placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω">
          </div>

          <div class="form-actions">
            <button class="save-button" (click)="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="cancel-button" (click)="cancelEditingProfile()">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –ó–∞–∫–∞–∑—ã -->
    <div class="tab-panel" *ngIf="activeTab === 'orders'">
      <!-- –§–∏–ª—å—Ç—Ä—ã –∑–∞–∫–∞–∑–æ–≤ -->
      <div class="order-filters">
        <button
          class="filter-button"
          [class.active]="orderFilter === 'all'"
          (click)="setOrderFilter('all')">
          –í—Å–µ –∑–∞–∫–∞–∑—ã
        </button>
        <button
          class="filter-button"
          [class.active]="orderFilter === 'active'"
          (click)="setOrderFilter('active')">
          –ê–∫—Ç–∏–≤–Ω—ã–µ
        </button>
        <button
          class="filter-button"
          [class.active]="orderFilter === 'completed'"
          (click)="setOrderFilter('completed')">
          –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ
        </button>
        <button
          class="filter-button"
          [class.active]="orderFilter === 'cancelled'"
          (click)="setOrderFilter('cancelled')">
          –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ
        </button>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ -->
      <div class="orders-list" *ngIf="filteredOrders.length > 0">
        <div class="order-card" *ngFor="let order of filteredOrders">
          <div class="order-header">
            <div class="order-info">
              <div class="order-number">–ó–∞–∫–∞–∑ #{{ order.id.substring(0, 8) }}</div>
              <div class="order-date">{{ formatOrderDate(order.createdAt) }}</div>
            </div>
            <div class="order-status" [style.color]="getOrderStatusInfo(order.status).color">
              <span class="status-icon">{{ getOrderStatusInfo(order.status).icon }}</span>
              <span class="status-text">{{ getOrderStatusInfo(order.status).text }}</span>
            </div>
          </div>

          <div class="order-restaurant">
            <div class="restaurant-name">{{ order.restaurant.name }}</div>
            <div class="restaurant-address">{{ order.restaurant.address }}</div>
          </div>

          <div class="order-items">
            <div class="order-item" *ngFor="let item of order.items">
              <div class="item-info">
                <div class="item-name">{{ item.menuItem.name }}</div>
                <div class="item-quantity">{{ item.quantity }} —à—Ç.</div>
              </div>
              <div class="item-price">{{ item.price }} ‚ÇΩ</div>
            </div>
          </div>

          <div class="order-footer">
            <div class="order-total">
              <span class="total-label">–ò—Ç–æ–≥–æ:</span>
              <span class="total-amount">{{ order.totalPrice }} ‚ÇΩ</span>
            </div>
            <div class="order-actions">
              <button class="action-button secondary" (click)="viewOrder(order.id)">
                –ü–æ–¥—Ä–æ–±–Ω–µ–µ
              </button>
              <button
                class="action-button primary"
                *ngIf="!['delivered', 'cancelled'].includes(order.status.toLowerCase())"
                (click)="trackOrder(order.id)">
                –û—Ç—Å–ª–µ–¥–∏—Ç—å
              </button>
            </div>
          </div>

          <!-- –ü—Ä–æ—Å—Ç–∞—è —Å–µ–∫—Ü–∏—è –æ—Ç–∑—ã–≤–æ–≤ -->
          <div class="review-section" *ngIf="canReviewRestaurant(order)">
            <div class="review-section-header">
              <h4>–û—Ü–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑</h4>
              <p>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏ –æ –∑–∞–∫–∞–∑–µ (–¥–æ—Å—Ç—É–ø–Ω–æ 3 –¥–Ω—è)</p>
            </div>

            <div class="review-buttons">
              <button
                class="review-button restaurant"
                (click)="startReview(order, 'Restaurant')">
                <span class="review-icon">üè™</span>
                <span>–û—Ü–µ–Ω–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω</span>
              </button>

              <div class="menu-items-buttons">
                <button
                  *ngFor="let orderItem of order.items"
                  class="review-button item"
                  (click)="startReview(order, 'MenuItem', orderItem.menuItem.id)">
                  <span class="review-icon">üçΩÔ∏è</span>
                  <span>{{ orderItem.menuItem.name }}</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
      <div class="empty-state" *ngIf="filteredOrders.length === 0">
        <div class="empty-icon">üì¶</div>
        <h3>–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h3>
        <p>–ö–æ–≥–¥–∞ –≤—ã —Å–¥–µ–ª–∞–µ—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑, –æ–Ω –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</p>
        <button class="primary-button" (click)="router.navigate(['/'])">
          –°–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑
        </button>
      </div>
    </div>

    <!-- –í–∫–ª–∞–¥–∫–∞ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <div class="tab-panel" *ngIf="activeTab === 'settings'">
      <!-- –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è -->
      <div class="settings-card">
        <div class="card-header">
          <h3>–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
        </div>

        <div class="settings-form" *ngIf="!isChangingPassword">
          <p>–î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–æ –º–µ–Ω—è–π—Ç–µ –ø–∞—Ä–æ–ª—å</p>
          <button class="primary-button" (click)="startChangingPassword()">
            –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
          </button>
        </div>

        <div class="settings-form" *ngIf="isChangingPassword">
          <div class="form-field">
            <label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
            <input
              type="password"
              [(ngModel)]="passwordForm.currentPassword"
              placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å">
          </div>
          <div class="form-field">
            <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
            <input
              type="password"
              [(ngModel)]="passwordForm.newPassword"
              placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
          </div>
          <div class="form-field">
            <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
            <input
              type="password"
              [(ngModel)]="passwordForm.confirmPassword"
              placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
          </div>

          <div class="form-actions">
            <button class="save-button" (click)="changePassword()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button class="cancel-button" (click)="cancelChangingPassword()">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      </div>

      <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
      <div class="settings-card">
        <div class="card-header">
          <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
        </div>
        <div class="settings-form">
          <div class="setting-item">
            <label>Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
            <input type="checkbox" checked>
          </div>
          <div class="setting-item">
            <label>Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
            <input type="checkbox" checked>
          </div>
          <div class="setting-item">
            <label>SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
            <input type="checkbox">
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
  <div class="error-message" *ngIf="error">
    {{ error }}
  </div>
</div>

<!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div class="loading-state" *ngIf="loading">
  <div class="spinner"></div>
  <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–∑—ã–≤–∞ -->
<div class="review-modal-backdrop" *ngIf="isLeavingReview" (click)="cancelReview()">
  <div class="review-modal" (click)="$event.stopPropagation()">
    <div class="review-modal-header">
      <h3>{{ reviewForm.targetType === 'Restaurant' ? '–û—Ü–µ–Ω–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω' : '–û—Ü–µ–Ω–∏—Ç—å –±–ª—é–¥–æ' }}</h3>
      <button class="close-button" (click)="cancelReview()" [disabled]="savingReview">√ó</button>
    </div>

    <div class="review-modal-content">
      <div class="review-target-info">
        <h4>{{ reviewForm.targetName }}</h4>
        <p>{{ reviewForm.targetType === 'Restaurant' ? '–ö–∞–∫ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è —ç—Ç–æ—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω?' : '–ö–∞–∫ –≤–∞–º –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å —ç—Ç–æ –±–ª—é–¥–æ?' }}</p>
      </div>

      <!-- –†–µ–π—Ç–∏–Ω–≥ -->
      <div class="rating-section">
        <label>–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞:</label>
        <div class="star-rating">
          <button
            *ngFor="let star of [1,2,3,4,5]"
            class="star-button"
            [class.active]="star <= reviewForm.rating"
            (click)="setRating(star)"
            [disabled]="savingReview">
            ‚òÖ
          </button>
        </div>
        <span class="rating-text">{{ reviewForm.rating }} –∏–∑ 5</span>
      </div>

      <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
      <div class="comment-section">
        <label for="reviewComment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
        <textarea
          id="reviewComment"
          [(ngModel)]="reviewForm.comment"
          placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º–∏ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏..."
          rows="4"
          [disabled]="savingReview">
        </textarea>
      </div>

      <!-- –î–µ–π—Å—Ç–≤–∏—è -->
      <div class="review-modal-actions">
        <button
          class="cancel-button"
          (click)="cancelReview()"
          [disabled]="savingReview">
          –û—Ç–º–µ–Ω–∞
        </button>
        <button
          class="save-button"
          (click)="saveReview()"
          [disabled]="savingReview">
          <span *ngIf="!savingReview">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∑—ã–≤</span>
          <span *ngIf="savingReview">–°–æ—Ö—Ä–∞–Ω—è–µ–º...</span>
        </button>
      </div>
    </div>
  </div>
</div>
