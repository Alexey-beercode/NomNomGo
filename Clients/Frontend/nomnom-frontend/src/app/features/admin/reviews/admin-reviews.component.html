<!-- src/app/features/admin/reviews/admin-reviews.component.html -->

<div class="admin-reviews">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞–º–∏</h1>
      <p class="page-description">–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏ –º–æ–¥–µ—Ä–∏—Ä—É–π—Ç–µ –æ—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="refreshData()">
        <span class="btn-icon">üîÑ</span>
        –û–±–Ω–æ–≤–∏—Ç—å
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-container">
      <app-input
        placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É –æ—Ç–∑—ã–≤–∞ –∏–ª–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."
        [value]="filters.search || ''"
        (valueChange)="onSearchChange($event)">
      </app-input>
    </div>

    <div class="filters-container">
      <div class="filter-group">
        <label class="filter-label">–¢–∏–ø:</label>
        <select class="filter-select" [(ngModel)]="filters.targetType" (change)="onFilterChange()">
          <option [ngValue]="undefined">–í—Å–µ —Ç–∏–ø—ã</option>
          <option value="Restaurant">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã</option>
          <option value="MenuItem">–ë–ª—é–¥–∞</option>
          <option value="Courier">–ö—É—Ä—å–µ—Ä—ã</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">–†–µ–π—Ç–∏–Ω–≥:</label>
        <select class="filter-select" [(ngModel)]="filters.rating" (change)="onFilterChange()">
          <option [ngValue]="undefined">–í—Å–µ —Ä–µ–π—Ç–∏–Ω–≥–∏</option>
          <option [ngValue]="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
          <option [ngValue]="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
          <option [ngValue]="3">‚≠ê‚≠ê‚≠ê (3)</option>
          <option [ngValue]="2">‚≠ê‚≠ê (2)</option>
          <option [ngValue]="1">‚≠ê (1)</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">–°—Ç–∞—Ç—É—Å:</label>
        <select class="filter-select" [(ngModel)]="filters.isHidden" (change)="onFilterChange()">
          <option [ngValue]="undefined">–í—Å–µ –æ—Ç–∑—ã–≤—ã</option>
          <option [ngValue]="false">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ</option>
          <option [ngValue]="true">–°–∫—Ä—ã—Ç—ã–µ</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">–î–∞—Ç–∞ –æ—Ç:</label>
        <input type="date" class="filter-select" [(ngModel)]="filters.dateFrom" (change)="onFilterChange()">
      </div>

      <div class="filter-group">
        <label class="filter-label">–î–∞—Ç–∞ –¥–æ:</label>
        <input type="date" class="filter-select" [(ngModel)]="filters.dateTo" (change)="onFilterChange()">
      </div>

      <div class="filter-group">
        <label class="filter-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
        <select class="filter-select" [(ngModel)]="filters.sortBy" (change)="onFilterChange()">
          <option value="createdAt">–ü–æ –¥–∞—Ç–µ</option>
          <option value="rating">–ü–æ —Ä–µ–π—Ç–∏–Ω–≥—É</option>
          <option value="userName">–ü–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">–ü–æ—Ä—è–¥–æ–∫:</label>
        <select class="filter-select" [(ngModel)]="filters.sortOrder" (change)="onFilterChange()">
          <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
          <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Reviews Stats -->
  <div class="stats-section">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üí¨</div>
        <div class="stat-content">
          <div class="stat-value">{{ getTotalReviews() }}</div>
          <div class="stat-label">–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤</div>
        </div>
      </div>
      <div class="stat-card positive">
        <div class="stat-icon">üëç</div>
        <div class="stat-content">
          <div class="stat-value">{{ getPositiveReviews() }}</div>
          <div class="stat-label">–ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ (4-5‚≠ê)</div>
        </div>
      </div>
      <div class="stat-card negative">
        <div class="stat-icon">üëé</div>
        <div class="stat-content">
          <div class="stat-value">{{ getNegativeReviews() }}</div>
          <div class="stat-label">–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ (1-2‚≠ê)</div>
        </div>
      </div>
      <div class="stat-card average">
        <div class="stat-icon">‚≠ê</div>
        <div class="stat-content">
          <div class="stat-value">{{ getAverageRating() }}</div>
          <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
        </div>
      </div>
      <div class="stat-card hidden">
        <div class="stat-icon">üëÅÔ∏è‚Äçüó®Ô∏è</div>
        <div class="stat-content">
          <div class="stat-value">{{ getHiddenReviews() }}</div>
          <div class="stat-label">–°–∫—Ä—ã—Ç—ã–µ –æ—Ç–∑—ã–≤—ã</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã...</p>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error && !loading">
    <div class="error-message">
      <span class="error-icon">‚ö†Ô∏è</span>
      {{ error }}
    </div>
    <button class="btn btn-secondary" (click)="refreshData()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  </div>

  <!-- Content -->
  <div class="content-section" *ngIf="!loading && !error">
    <!-- Reviews Grid -->
    <div class="reviews-grid" *ngIf="filteredReviews.length > 0">
      <div *ngFor="let review of filteredReviews; trackBy: trackReview"
           class="review-card"
           [class.hidden-review]="review.isHidden">

        <!-- Review Header -->
        <div class="review-header">
          <div class="user-info">
            <div class="user-avatar">
              {{ getUserInitials(review.userName) }}
            </div>
            <div class="user-details">
              <div class="user-name">{{ review.userName }}</div>
              <div class="review-date">{{ formatDateTime(review.createdAt) }}</div>
            </div>
          </div>
          <div class="review-rating">
            <div class="stars">
              <span *ngFor="let star of getStarsArray(review.rating)"
                    [class]="star ? 'star filled' : 'star empty'">‚≠ê</span>
            </div>
            <span class="rating-number">({{ review.rating }})</span>
          </div>
        </div>

        <!-- Target Info -->
        <div class="target-info">
          <div class="target-type">
            <span class="type-badge" [class]="getTargetTypeClass(review.targetType)">
              {{ getTargetTypeText(review.targetType) }}
            </span>
          </div>
          <div class="target-name">{{ review.targetName }}</div>
        </div>

        <!-- Review Content -->
        <div class="review-content">
          <div class="review-text" [class.expanded]="review.expanded">
            {{ review.comment }}
          </div>
          <button *ngIf="review.comment && review.comment.length > 200"
                  class="expand-btn"
                  (click)="toggleReviewExpansion(review)">
            {{ review.expanded ? '–°–≤–µ—Ä–Ω—É—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é' }}
          </button>
        </div>

        <!-- Sentiment Analysis (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
        <div class="sentiment-analysis" *ngIf="review.sentiment">
          <span class="sentiment-badge" [class]="getSentimentClass(review.sentiment)">
            {{ getSentimentText(review.sentiment) }}
          </span>
        </div>

        <!-- Review Status -->
        <div class="review-status" *ngIf="review.isHidden">
          <span class="status-badge hidden">–°–∫—Ä—ã—Ç</span>
          <div class="hidden-reason" *ngIf="review.hiddenReason">
            –ü—Ä–∏—á–∏–Ω–∞: {{ review.hiddenReason }}
          </div>
        </div>

        <!-- Review Actions -->
        <div class="review-actions">
          <button class="action-btn view"
                  (click)="openViewModal(review)"
                  title="–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">
            üëÅÔ∏è
          </button>
          <button class="action-btn hide"
                  (click)="toggleReviewVisibility(review)"
                  [title]="review.isHidden ? '–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–∑—ã–≤' : '–°–∫—Ä—ã—Ç—å –æ—Ç–∑—ã–≤'">
            {{ review.isHidden ? 'üëÅÔ∏è' : 'üôà' }}
          </button>
          <button class="action-btn delete"
                  (click)="openDeleteModal(review)"
                  title="–£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤">
            üóëÔ∏è
          </button>
          <button class="action-btn report"
                  (click)="openReportModal(review)"
                  title="–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è">
            üö©
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredReviews.length === 0">
      <div class="empty-icon">üí¨</div>
      <h3>–û—Ç–∑—ã–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
      <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
      <button class="btn btn-secondary" (click)="clearFilters()">
        –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
      </button>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" *ngIf="modalState.isOpen" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ modalState.title }}</h2>
      <button class="modal-close" (click)="closeModal()">√ó</button>
    </div>

    <!-- Review Details Modal -->
    <div class="modal-body" *ngIf="modalState.type === 'view' && modalState.data">
      <div class="review-details-modal">
        <div class="detail-section">
          <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</label>
              <span>{{ modalState.data.userName }}</span>
            </div>
            <div class="detail-item">
              <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
              <span>{{ modalState.data.userId }}</span>
            </div>
            <div class="detail-item">
              <label>–î–∞—Ç–∞ –æ—Ç–∑—ã–≤–∞:</label>
              <span>{{ formatDateTime(modalState.data.createdAt) }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>–û–±—ä–µ–∫—Ç –æ—Ç–∑—ã–≤–∞</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>–¢–∏–ø:</label>
              <span class="type-badge" [class]="getTargetTypeClass(modalState.data.targetType)">
                {{ getTargetTypeText(modalState.data.targetType) }}
              </span>
            </div>
            <div class="detail-item">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
              <span>{{ modalState.data.targetName }}</span>
            </div>
            <div class="detail-item">
              <label>ID –æ–±—ä–µ–∫—Ç–∞:</label>
              <span>{{ modalState.data.targetId }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>–û—Ü–µ–Ω–∫–∞ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
          <div class="rating-display">
            <div class="stars-large">
              <span *ngFor="let star of getStarsArray(modalState.data.rating)"
                    [class]="star ? 'star filled' : 'star empty'">‚≠ê</span>
            </div>
            <span class="rating-text">{{ modalState.data.rating }} –∏–∑ 5</span>
          </div>
          <div class="comment-display" *ngIf="modalState.data.comment">
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
            <div class="comment-text">{{ modalState.data.comment }}</div>
          </div>
        </div>

        <div class="detail-section" *ngIf="modalState.data.sentiment">
          <h3>–ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏</h3>
          <div class="sentiment-display">
            <span class="sentiment-badge large" [class]="getSentimentClass(modalState.data.sentiment)">
              {{ getSentimentText(modalState.data.sentiment) }}
            </span>
          </div>
        </div>

        <div class="detail-section" *ngIf="modalState.data.isHidden">
          <h3>–°—Ç–∞—Ç—É—Å –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h3>
          <div class="moderation-info">
            <span class="status-badge hidden">–û—Ç–∑—ã–≤ —Å–∫—Ä—ã—Ç</span>
            <div class="hidden-reason" *ngIf="modalState.data.hiddenReason">
              <label>–ü—Ä–∏—á–∏–Ω–∞:</label>
              <span>{{ modalState.data.hiddenReason }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hide/Show Confirmation -->
    <div class="modal-body" *ngIf="modalState.type === 'hide' || modalState.type === 'show'">
      <div class="action-confirmation">
        <div class="warning-icon">{{ modalState.type === 'hide' ? 'üôà' : 'üëÅÔ∏è' }}</div>
        <p>
          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ {{ modalState.type === 'hide' ? '—Å–∫—Ä—ã—Ç—å' : '–ø–æ–∫–∞–∑–∞—Ç—å' }} —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?
        </p>
        <div class="form-group" *ngIf="modalState.type === 'hide'">
          <label for="hideReason">–ü—Ä–∏—á–∏–Ω–∞ —Å–∫—Ä—ã—Ç–∏—è:</label>
          <textarea id="hideReason"
                    class="form-textarea"
                    [(ngModel)]="hideReason"
                    placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Å–∫—Ä—ã—Ç–∏—è –æ—Ç–∑—ã–≤–∞..."></textarea>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation -->
    <div class="modal-body" *ngIf="modalState.type === 'delete'">
      <div class="delete-confirmation">
        <div class="warning-icon">üóëÔ∏è</div>
        <p>
          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ <strong>—É–¥–∞–ª–∏—Ç—å</strong> —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?
        </p>
        <p class="warning-text">
          –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å. –û—Ç–∑—ã–≤ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞.
        </p>
        <div class="form-group">
          <label for="deleteReason">–ü—Ä–∏—á–∏–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è:</label>
          <textarea id="deleteReason"
                    class="form-textarea"
                    [(ngModel)]="deleteReason"
                    placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞..."></textarea>
        </div>
      </div>
    </div>

    <!-- Report Modal -->
    <div class="modal-body" *ngIf="modalState.type === 'report'">
      <div class="report-form">
        <h4>–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –æ—Ç–∑—ã–≤</h4>
        <div class="form-group">
          <label for="reportReason">–ü—Ä–∏—á–∏–Ω–∞ –∂–∞–ª–æ–±—ã:</label>
          <select id="reportReason" class="form-select" [(ngModel)]="reportReason">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É</option>
            <option value="spam">–°–ø–∞–º</option>
            <option value="inappropriate">–ù–µ–ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç</option>
            <option value="fake">–ü–æ–¥–¥–µ–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤</option>
            <option value="offensive">–û—Å–∫–æ—Ä–±–∏—Ç–µ–ª—å–Ω—ã–π —è–∑—ã–∫</option>
            <option value="other">–î—Ä—É–≥–æ–µ</option>
          </select>
        </div>
        <div class="form-group">
          <label for="reportComment">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</label>
          <textarea id="reportComment"
                    class="form-textarea"
                    [(ngModel)]="reportComment"
                    placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–µ–µ..."></textarea>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">
        –û—Ç–º–µ–Ω–∞
      </button>

      <button *ngIf="modalState.type === 'hide'"
              class="btn btn-warning"
              [disabled]="!hideReason?.trim()"
              (click)="confirmHideReview()">
        –°–∫—Ä—ã—Ç—å –æ—Ç–∑—ã–≤
      </button>

      <button *ngIf="modalState.type === 'show'"
              class="btn btn-primary"
              (click)="confirmShowReview()">
        –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–∑—ã–≤
      </button>

      <button *ngIf="modalState.type === 'delete'"
              class="btn btn-danger"
              [disabled]="!deleteReason?.trim()"
              (click)="confirmDeleteReview()">
        –£–¥–∞–ª–∏—Ç—å –æ—Ç–∑—ã–≤
      </button>

      <button *ngIf="modalState.type === 'report'"
              class="btn btn-warning"
              [disabled]="!reportReason"
              (click)="confirmReportReview()">
        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É
      </button>
    </div>
  </div>
</div>
