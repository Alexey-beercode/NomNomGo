<!-- src/app/features/admin/users/admin-users.component.html -->

<div class="admin-users">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
      <p class="page-description">–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å–∏—Å—Ç–µ–º—ã</p>
    </div>
    <div class="header-actions">
      <button
        class="btn btn-secondary"
        (click)="refreshData()"
        [disabled]="loading">
        <span *ngIf="loading">üîÑ</span>
        <span *ngIf="!loading">‚Üª</span>
        –û–±–Ω–æ–≤–∏—Ç—å
      </button>
    </div>
  </div>

  <!-- Error message -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
    <button class="alert-close" (click)="error = ''">√ó</button>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-container">
      <app-input
        placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É..."
        [value]="filters.search || ''"
        (valueChange)="onSearchChange($event)">
      </app-input>
    </div>

    <div class="filters-container">
      <div class="filter-group">
        <label class="filter-label">–†–æ–ª—å:</label>
        <select class="filter-select" [(ngModel)]="filters.role" (change)="onFilterChange()">
          <option [ngValue]="undefined">–í—Å–µ —Ä–æ–ª–∏</option>
          <option value="USER">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
          <option value="ADMIN">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
          <option value="MANAGER">–ú–µ–Ω–µ–¥–∂–µ—Ä—ã</option>
          <option value="COURIER">–ö—É—Ä—å–µ—Ä—ã</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">–°—Ç–∞—Ç—É—Å:</label>
        <select class="filter-select" [(ngModel)]="filters.isBlocked" (change)="onFilterChange()">
          <option [ngValue]="undefined">–í—Å–µ</option>
          <option [ngValue]="false">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
          <option [ngValue]="true">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
        <select class="filter-select" [(ngModel)]="filters.sortBy" (change)="onFilterChange()">
          <option value="username">–ü–æ –∏–º–µ–Ω–∏</option>
          <option value="email">–ü–æ email</option>
          <option value="createdAt">–ü–æ –¥–∞—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</option>
        </select>
      </div>

      <div class="filter-group">
        <label class="filter-label">–ü–æ—Ä—è–¥–æ–∫:</label>
        <select class="filter-select" [(ngModel)]="filters.sortOrder" (change)="onFilterChange()">
          <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
          <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
        </select>
      </div>

      <div class="filter-actions">
        <button class="btn btn-secondary" (click)="clearFilters()">
          –û—á–∏—Å—Ç–∏—Ç—å
        </button>
      </div>
    </div>
  </div>

  <!-- Users Stats -->
  <div class="stats-section">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üë•</div>
        <div class="stat-content">
          <div class="stat-value">{{ getTotalUsers() }}</div>
          <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
          <div class="stat-value">{{ getActiveUsers() }}</div>
          <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üö´</div>
        <div class="stat-content">
          <div class="stat-value">{{ getBlockedUsers() }}</div>
          <div class="stat-label">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üëë</div>
        <div class="stat-content">
          <div class="stat-value">{{ getAdminUsers() }}</div>
          <div class="stat-label">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</p>
  </div>

  <!-- Content -->
  <div class="content-section" *ngIf="!loading">
    <!-- Table View -->
    <div class="table-container" *ngIf="filteredUsers.length > 0">
      <table class="users-table">
        <thead>
        <tr>
          <th class="sortable" (click)="onSortChange('username')">
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            <span class="sort-indicator">{{ getSortIcon('username') }}</span>
          </th>
          <th class="sortable" (click)="onSortChange('email')">
            Email
            <span class="sort-indicator">{{ getSortIcon('email') }}</span>
          </th>
          <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
          <th>–†–æ–ª–∏</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th class="sortable" (click)="onSortChange('createdAt')">
            –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            <span class="sort-indicator">{{ getSortIcon('createdAt') }}</span>
          </th>
          <th class="actions-col">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let user of filteredUsers; trackBy: trackUser"
            [class.blocked-user]="user.isBlocked">
          <td class="user-info">
            <div class="user-avatar">
              {{ getUserInitials(user.username) }}
            </div>
            <div class="user-details">
              <div class="username">{{ user.username }}</div>
              <div class="user-id">ID: {{ user.userId.substring(0, 8) }}...</div>
            </div>
          </td>

          <td class="email-cell">{{ user.email }}</td>

          <td class="phone-cell">{{ user.phoneNumber || '–ù–µ —É–∫–∞–∑–∞–Ω' }}</td>

          <td class="roles">
              <span *ngFor="let role of user.roles"
                    class="role-badge"
                    [class]="getRoleClass(role)">
                {{ getRoleDisplayName(role) }}
              </span>
          </td>

          <td class="status">
              <span class="status-badge" [class]="getStatusClass(user.isBlocked)">
                {{ getStatusText(user.isBlocked) }}
              </span>
            <div *ngIf="user.isBlocked && user.blockedUntil" class="blocked-until">
              –¥–æ {{ formatDate(user.blockedUntil) }}
            </div>
          </td>

          <td class="registration">
            <div class="reg-date">{{ formatDate(user.createdAt) }}</div>
          </td>

          <td class="actions">
            <div class="action-buttons">
              <button class="action-btn view"
                      (click)="openViewModal(user)"
                      title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                üëÅÔ∏è
              </button>
              <button class="action-btn block"
                      (click)="openBlockModal(user)"
                      [title]="user.isBlocked ? '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'">
                {{ user.isBlocked ? 'üîì' : 'üîí' }}
              </button>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredUsers.length === 0">
      <div class="empty-icon">üë•</div>
      <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
      <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
      <button class="btn btn-secondary" (click)="clearFilters()">
        –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
      </button>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" *ngIf="modalState.isOpen" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ modalState.title }}</h2>
      <button class="modal-close" (click)="closeModal()">√ó</button>
    </div>

    <!-- User Details Modal -->
    <div class="modal-body" *ngIf="modalState.type === 'view' && modalState.data">
      <div class="user-details-modal">
        <div class="detail-section">
          <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
              <span>{{ modalState.data.username }}</span>
            </div>
            <div class="detail-item">
              <label>Email:</label>
              <span>{{ modalState.data.email }}</span>
            </div>
            <div class="detail-item">
              <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
              <span>{{ modalState.data.phoneNumber || '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span>
            </div>
            <div class="detail-item">
              <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
              <span class="user-id-full">{{ modalState.data.userId }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>–†–æ–ª–∏ –∏ —Å—Ç–∞—Ç—É—Å</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>–†–æ–ª–∏:</label>
              <div class="roles-list">
                <span *ngFor="let role of modalState.data.roles"
                      class="role-badge"
                      [class]="getRoleClass(role)">
                  {{ getRoleDisplayName(role) }}
                </span>
              </div>
            </div>
            <div class="detail-item">
              <label>–°—Ç–∞—Ç—É—Å:</label>
              <span class="status-badge" [class]="getStatusClass(modalState.data.isBlocked)">
                {{ getStatusText(modalState.data.isBlocked) }}
              </span>
            </div>
            <div class="detail-item" *ngIf="modalState.data.isBlocked && modalState.data.blockedUntil">
              <label>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ:</label>
              <span>{{ formatDate(modalState.data.blockedUntil) }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>–î–∞—Ç—ã</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</label>
              <span>{{ formatDateTime(modalState.data.createdAt) }}</span>
            </div>
            <div class="detail-item">
              <label>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</label>
              <span>{{ formatDateTime(modalState.data.updatedAt) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Block User Modal -->
    <div class="modal-body" *ngIf="modalState.type === 'block' && modalState.data">
      <div class="block-form">
        <div class="warning-icon">üîí</div>
        <p>
          –í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          <strong>{{ modalState.data.username }}</strong>
        </p>

        <div class="form-group">
          <label for="blockDuration">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:</label>
          <select id="blockDuration" [(ngModel)]="blockForm.duration" class="form-select">
            <option *ngFor="let duration of availableDurations" [value]="duration.value">
              {{ duration.label }}
            </option>
          </select>
        </div>
      </div>
    </div>

    <!-- Unblock User Modal -->
    <div class="modal-body" *ngIf="modalState.type === 'unblock' && modalState.data">
      <div class="unblock-confirmation">
        <div class="warning-icon">üîì</div>
        <p>
          –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          <strong>{{ modalState.data.username }}</strong>?
        </p>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">
        –û—Ç–º–µ–Ω–∞
      </button>

      <button *ngIf="modalState.type === 'block'"
              class="btn btn-warning"
              (click)="blockUser()">
        –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ {{ getDurationDisplayName(blockForm.duration) }}
      </button>

      <button *ngIf="modalState.type === 'unblock'"
              class="btn btn-primary"
              (click)="unblockUser()">
        –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
      </button>
    </div>
  </div>
</div>
