<!-- src/app/features/admin/orders/admin-orders.component.html -->

<div class="admin-orders">
  <!-- Header -->
  <div class="page-header">
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h1>
    <div class="header-actions">
      <button
        class="btn btn-secondary"
        (click)="refreshData()"
        [disabled]="loading">
        <span *ngIf="loading">üîÑ</span>
        <span *ngIf="!loading">‚Üª</span>
        –û–±–Ω–æ–≤–∏—Ç—å
      </button>
    </div>
  </div>

  <!-- Error message -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
    <button class="alert-close" (click)="error = ''">√ó</button>
  </div>

  <!-- Stats cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value">{{ getTotalOrders() }}</div>
      <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ getPendingOrders() }}</div>
      <div class="stat-label">–û–∂–∏–¥–∞—é—Ç</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ getActiveOrders() }}</div>
      <div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ getCompletedOrders() }}</div>
      <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ formatCurrency(getTotalRevenue()) }}</div>
      <div class="stat-label">–í—ã—Ä—É—á–∫–∞</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="filters-row">
      <div class="filter-group">
        <app-input
          label="–ü–æ–∏—Å–∫"
          [value]="filters.search"
          (valueChange)="onSearchChange($event)"
          placeholder="–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞, —Ä–µ—Å—Ç–æ—Ä–∞–Ω, –∞–¥—Ä–µ—Å...">
        </app-input>
      </div>

      <div class="filter-group">
        <label>–°—Ç–∞—Ç—É—Å</label>
        <select [(ngModel)]="filters.status" (change)="onFilterChange()">
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option *ngFor="let status of getAllStatusOptions()" [value]="status.value">
            {{ status.label }}
          </option>
        </select>
      </div>

      <div class="filter-group">
        <label>–° –¥–∞—Ç—ã</label>
        <input
          type="date"
          [(ngModel)]="filters.dateFrom"
          (change)="onFilterChange()">
      </div>

      <div class="filter-group">
        <label>–ü–æ –¥–∞—Ç—É</label>
        <input
          type="date"
          [(ngModel)]="filters.dateTo"
          (change)="onFilterChange()">
      </div>

      <div class="filter-actions">
        <button class="btn btn-secondary" (click)="clearFilters()">
          –û—á–∏—Å—Ç–∏—Ç—å
        </button>
      </div>
    </div>
  </div>

  <!-- Loading indicator -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</p>
  </div>

  <!-- Orders table -->
  <div *ngIf="!loading" class="table-container">
    <table class="orders-table">
      <thead>
      <tr>
        <th (click)="onSortChange('id')" class="sortable">
          –ù–æ–º–µ—Ä {{ getSortIcon('id') }}
        </th>
        <th (click)="onSortChange('createdAt')" class="sortable">
          –î–∞—Ç–∞ {{ getSortIcon('createdAt') }}
        </th>
        <th>–†–µ—Å—Ç–æ—Ä–∞–Ω</th>
        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
        <th>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</th>
        <th (click)="onSortChange('status')" class="sortable">
          –°—Ç–∞—Ç—É—Å {{ getSortIcon('status') }}
        </th>
        <th (click)="onSortChange('totalPrice')" class="sortable">
          –°—É–º–º–∞ {{ getSortIcon('totalPrice') }}
        </th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let order of filteredOrders; trackBy: trackOrder" class="order-row">
        <td class="order-number">
          {{ getOrderNumber(order.id) }}
        </td>
        <td class="order-date">
          <div>{{ formatDate(order.createdAt) }}</div>
        </td>
        <td class="restaurant-name">
          {{ order.restaurant.name }}
        </td>
        <td class="user-id">
          {{ order.userId }}
        </td>
        <td class="delivery-address">
          {{ order.deliveryAddress }}
        </td>
        <td class="order-status">
            <span [class]="'status-badge ' + getStatusClass(order.status)">
              {{ getStatusText(order.status) }}
            </span>
        </td>
        <td class="order-total">
          <div class="price-info">
            <div class="total-price">{{ formatCurrency(order.totalPrice) }}</div>
            <div *ngIf="order.discountAmount > 0" class="discount">
              -{{ formatCurrency(order.discountAmount) }}
            </div>
          </div>
        </td>
        <td class="actions">
          <button
            class="btn btn-sm btn-primary"
            (click)="openViewModal(order)"
            title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
            üëÅÔ∏è
          </button>
          <button
            *ngIf="canChangeStatus(order.status)"
            class="btn btn-sm btn-secondary"
            (click)="openStatusModal(order)"
            title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å">
            üìù
          </button>
          <button
            *ngIf="canChangeStatus(order.status) && order.status !== 'CANCELLED'"
            class="btn btn-sm btn-danger"
            (click)="openCancelModal(order)"
            title="–û—Ç–º–µ–Ω–∏—Ç—å">
            ‚ùå
          </button>
        </td>
      </tr>
      </tbody>
    </table>

    <!-- Empty state -->
    <div *ngIf="filteredOrders.length === 0" class="empty-state">
      <div class="empty-icon">üìã</div>
      <h3>–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
      <p *ngIf="filters.search || filters.status || filters.dateFrom || filters.dateTo">
        –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
      </p>
      <p *ngIf="!filters.search && !filters.status && !filters.dateFrom && !filters.dateTo">
        –ó–∞–∫–∞–∑—ã –µ—â–µ –Ω–µ –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã
      </p>
    </div>
  </div>
</div>

<!-- Modal -->
<div *ngIf="modalState.isOpen" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ modalState.title }}</h2>
      <button class="modal-close" (click)="closeModal()">√ó</button>
    </div>

    <div class="modal-body">
      <!-- View Order Modal -->
      <div *ngIf="modalState.type === 'view' && modalState.data" class="order-details">
        <div class="detail-section">
          <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <label>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</label>
              <span>{{ getOrderNumber(modalState.data.id) }}</span>
            </div>
            <div class="detail-item">
              <label>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</label>
              <span>{{ formatDateTime(modalState.data.createdAt) }}</span>
            </div>
            <div class="detail-item">
              <label>–°—Ç–∞—Ç—É—Å:</label>
              <span [class]="'status-badge ' + getStatusClass(modalState.data.status)">
                {{ getStatusText(modalState.data.status) }}
              </span>
            </div>
            <div class="detail-item">
              <label>–†–µ—Å—Ç–æ—Ä–∞–Ω:</label>
              <span>{{ modalState.data.restaurant.name }}</span>
            </div>
            <div class="detail-item">
              <label>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</label>
              <span>{{ modalState.data.userId }}</span>
            </div>
            <div class="detail-item">
              <label>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
              <span>{{ modalState.data.deliveryAddress }}</span>
            </div>
            <div *ngIf="modalState.data.notes" class="detail-item full-width">
              <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:</label>
              <span>{{ modalState.data.notes }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>–°–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞</h3>
          <div class="order-items">
            <div *ngFor="let item of modalState.data.items" class="order-item">
              <div class="item-info">
                <div class="item-name">{{ item.menuItem.name }}</div>
                <div class="item-description">{{ item.menuItem.description }}</div>
              </div>
              <div class="item-quantity">{{ item.quantity }} —à—Ç.</div>
              <div class="item-price">{{ formatCurrency(item.price) }}</div>
              <div class="item-total">{{ formatCurrency(item.price * item.quantity) }}</div>
            </div>
          </div>

          <div class="order-totals">
            <div class="total-row">
              <span>–°—É–º–º–∞ –∑–∞–∫–∞–∑–∞:</span>
              <span>{{ formatCurrency(modalState.data.totalPrice) }}</span>
            </div>
            <div *ngIf="modalState.data.discountAmount > 0" class="total-row discount">
              <span>–°–∫–∏–¥–∫–∞:</span>
              <span>-{{ formatCurrency(modalState.data.discountAmount) }}</span>
            </div>
            <div class="total-row final">
              <span>–ö –æ–ø–ª–∞—Ç–µ:</span>
              <span>{{ formatCurrency(modalState.data.totalPrice - modalState.data.discountAmount) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Update Status Modal -->
      <div *ngIf="modalState.type === 'status' && modalState.data" class="status-form">
        <div class="form-group">
          <label for="newStatus">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:</label>
          <select id="newStatus" [(ngModel)]="statusUpdateForm.newStatus">
            <option *ngFor="let status of getAvailableStatuses(modalState.data.status)"
                    [value]="status.value">
              {{ status.label }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="statusNotes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
          <textarea
            id="statusNotes"
            [(ngModel)]="statusUpdateForm.notes"
            placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞..."
            rows="3">
          </textarea>
        </div>
      </div>

      <!-- Cancel Order Modal -->
      <div *ngIf="modalState.type === 'cancel' && modalState.data" class="cancel-form">
        <div class="warning-message">
          <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑ {{ getOrderNumber(modalState.data.id) }}?</p>
        </div>

        <div class="form-group">
          <label for="cancelReason">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã:</label>
          <textarea
            id="cancelReason"
            [(ngModel)]="cancelReason"
            placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞..."
            rows="3"
            required>
          </textarea>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">
        –û—Ç–º–µ–Ω–∞
      </button>

      <button *ngIf="modalState.type === 'status'"
              class="btn btn-primary"
              (click)="updateOrderStatus()"
              [disabled]="!statusUpdateForm.newStatus">
        –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
      </button>

      <button *ngIf="modalState.type === 'cancel'"
              class="btn btn-danger"
              (click)="cancelOrder()"
              [disabled]="!cancelReason?.trim()">
        –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑
      </button>
    </div>
  </div>
</div>
